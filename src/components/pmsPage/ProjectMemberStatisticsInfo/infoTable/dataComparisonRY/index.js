import React, {useEffect, useState} from 'react';
import {Button, Empty, message, Modal, Select, Spin, Tabs} from 'antd';
import {useLocation} from 'react-router';
import echarts from 'echarts/lib/echarts';
import 'echarts/lib/chart/pie';
import 'echarts/lib/component/tooltip';
import 'echarts/lib/component/legend';
import 'echarts/lib/component/legendScroll';
import 'echarts/lib/component/title';
import 'echarts/lib/chart/radar';
import ReactEchartsCore from 'echarts-for-react/lib/core';
import {QueryMemberInfo, QueryProjectListPara, QueryProjectStatistics} from "../../../../../services/pmsServices";
import MemberAllTable from "../memberAllTable";
import {EncryptBase64} from "../../../../Common/Encrypt";
import {Link} from "react-router-dom";
import TreeUtils from "../../../../../utils/treeUtils";


const {TabPane} = Tabs;
const {Option} = Select;

export default function DataComparisonRY(props) {

  const [footerVisable, setFooterVisable] = useState('');
  const [detailVisable, setDetailVisable] = useState(false);
  const [tableDataRY, setTableDataRY] = useState([]);
  const [totalRY, setTotalRY] = useState(0);
  const [bmmc, setBMMC] = useState('');
  const [memberLoading, setMemberLoading] = useState(true);
  const [prjMnger, setPrjMnger] = useState(undefined); //‰∫∫ÂëòÈÄâÊã©
  const [staffData, setStaffData] = useState([]); //‰∫∫ÂëòÊï∞ÊçÆ

  // const [tooltipDataXMZS, setTooltipDataXMZS] = useState([]); //ÂèëËµ∑È°πÁõÆ
  // const [tooltipDataZBXM, setTooltipDataZBXM] = useState([]); //‰∏ìÁè≠È°πÁõÆ
  // const [tooltipDataKTXM, setTooltipDataKTXM] = useState([]); //ËØæÈ¢òÈ°πÁõÆ
  // const [tooltipDataCYXM, setTooltipDataCYXM] = useState([]); //ÂèÇ‰∏éÈ°πÁõÆ
  // const [tooltipDataHJXM, setTooltipDataHJXM] = useState([]); //Ëé∑Â•ñÈ°πÁõÆ
  const [tooltipData, setTooltipData] = useState([]); //tooltipÂ±ïÁ§∫Êï∞ÊçÆ
  const [tooltipleftData, setTooltipleftData] = useState([]); //tooltipÂ±ïÁ§∫Êï∞ÊçÆ
  const [radardata, setRadardata] = useState([]); //Èõ∑ËææÊï∞ÊçÆ
  //ÂêÑÈ°πÁõÆÁ±ªÂûãÊÄªÊï∞
  const [totalXMZS, setTotalXMZS] = useState(0); //ÂèëËµ∑È°πÁõÆÊÄªÊï∞
  const [totalZBXM, setTotalZBXM] = useState(0); //‰∏ìÁè≠È°πÁõÆÊÄªÊï∞
  const [totalKTXM, setTotalKTXM] = useState(0); //ËØæÈ¢òÈ°πÁõÆÊÄªÊï∞
  const [totalCYXM, setTotalCYXM] = useState(0); //ÂèÇ‰∏éÈ°πÁõÆÊÄªÊï∞
  const [totalHJXM, setTotalHJXM] = useState(0); //Ëé∑Â•ñÈ°πÁõÆÊÄªÊï∞
  const [totalZYXM, setTotalZYXM] = useState(0); //Ëé∑Â•ñÈ°πÁõÆÊÄªÊï∞
  const [totalWCXM, setTotalWCXM] = useState(0); //Ëé∑Â•ñÈ°πÁõÆÊÄªÊï∞
  const [totalArr, setTotalArr] = useState([0, 0, 0, 0, 0]); //Ëé∑Â•ñÈ°πÁõÆÊÄªÊï∞ÁªÑÊàêÁöÑÊï∞ÁªÑ
  const [totalNameArr, setTotalNameArr] = useState(['', '', '', '', '']); //‰∫∫ÂêçÁªÑÊàêÁöÑÊï∞ÁªÑ-legend

  const {
    userId = '',
    visible = false,
    closeModal,
    defaultYear
  } = props; //Ë°®Ê†ºÊï∞ÊçÆ
  const location = useLocation();

  useEffect(() => {
    getStaffData();
    if (userId !== undefined) {
      setPrjMnger(String(userId));
      getTableData('DRY', userId, defaultYear)
    }
    return () => {
    }
  }, [userId, visible, defaultYear]);
  // console.log("üöÄ ~ file: index.js:15 ~ InfoTable ~ location:", location)


  const getRadarChat = () => {
    // console.log("Èõ∑ËææÊï∞ÊçÆ",item)
    //Ëé∑ÂèñÈõ∑ËææÂõæÊï∞ÊçÆ
    let i = -1;
    let arr = [totalHJXM, totalKTXM, totalZBXM, totalZYXM, totalWCXM]
    let max = Math.max(...arr)
    // let max = maxtemp === 0 ? 0 : (maxtemp === 1 ? 1 : ((Math.log(maxtemp) / Math.log(Math.E)) + 1))
    let flag = totalHJXM === 0 && totalKTXM === 0 && totalZBXM === 0 && totalZYXM === 0 && totalWCXM === 0;
    return {
      // title: {
      //   text: 'Âü∫Á°ÄÈõ∑ËææÂõæ'
      // },
      legend: {
        data: totalNameArr,
        itemGap: 24,
        itemWidth: 10,
        itemHeight: 10,
      },
      color: ['rgba(91,143,249,1)', 'rgba(90,216,166,1)', 'rgba(93,112,146,1)', 'rgba(246,189,22,1)', 'rgba(232,104,74,1)'],
      tooltip: {
        extraCssText: 'padding:12px;height: 240px;background-color:#ffffff;color:#ffffff;box-shadow: 0px 3px 6px -4px rgba(0,0,0,0.12), 0px 6px 16px 0px rgba(0,0,0,0.08), 0px 9px 28px 8px rgba(0,0,0,0.05);',
        formatter: (params) => {
          console.log("paramsparams", params)
          //params.data.name
          //params.data.value
          //paramsÊòØÊï∞ÁªÑÊ†ºÂºè
          let str = ''
          for (let item of tooltipData) {
            str += '<span style="font-size: 14px;font-weight: 500;color: #303133;line-height: 22px;font-family: PingFangSC-Medium, PingFang SC;">' + item.xmlx + '</span><br/>'
            console.log("itemitemitem", item)
            item.data.map((i, index) => {
              if (index !== 0) {
                str += "<span style='display:inline-block;width:10px;height:10px;border-radius:10px;background-color:" + item + ";'></span>"
                  + '<span style="font-size: 14px;font-weight: 400;color: #909399;line-height: 22px;font-family: PingFangSC-Regular, PingFang SC;">' + 'ÔΩú' + i.name + " : " + '</span>'
                  + '<span style="font-size: 14px;font-weight: 400;color: #303133;line-height: 22px;font-family: PingFangSC-Regular, PingFang SC;">' + i.value + "\t" + '</span>'
              } else {
                str += "<span style='display:inline-block;width:10px;height:10px;border-radius:10px;background-color:" + item + ";'></span>"
                  + '<span style="font-size: 14px;font-weight: 400;color: #909399;line-height: 22px;font-family: PingFangSC-Regular, PingFang SC;">' + i.name + " : " + '</span>'
                  + '<span style="font-size: 14px;font-weight: 400;color: #303133;line-height: 22px;font-family: PingFangSC-Regular, PingFang SC;">' + i.value + "\t" + '</span>'
              }
            })
            str = str + '<br/>'
          }
          return str
        }
      },
      radar: [{
        center: ['50%', '55%'],
        // shape: 'circle',
        radius: 135.5,
        name: {
          textStyle: {
            color: '#999',
            backgroundColor: '#fff',
            borderRadius: 3,
            padding: [1, 1]
          },
          rich: {
            a: {
              fontSize: '14',
              color: '#999999',
              align: 'left',
              lineHeight: '20'
            },
            b: {
              fontSize: '14',
              color: '#333333',
              align: 'center',
              fontWeight: 'bold'
            }
          },
          formatter: (a) => {
            i++;
            return `{a|${a}}\n{b|${totalArr[i]}}`
          }
        },
        indicator: [
          {name: 'Ëé∑Â•ñÈ°πÁõÆ', max},
          {name: 'ËØæÈ¢òÈ°πÁõÆ', max},
          {name: '‰∏ìÁè≠È°πÁõÆ', max},
          {name: 'Ëá™Á†îÈ°πÁõÆ', max},
          {name: 'Â§ñÈááÈ°πÁõÆ', max},
        ],
        splitArea: {
          show: true,
          areaStyle: {
            color: ['#fff', '']
            // ÂõæË°®ËÉåÊôØÁΩëÊ†ºÁöÑÈ¢úËâ≤
          }
        },
      }],
      series: [{
        name: '',
        type: 'radar',
        lineStyle: {
          width: 2.5,
        },
        areaStyle: {
          opacity: 0.2,
        },
        data: flag ? [] : radardata,
      }]
    };
  }

  //Ëé∑Âèñ‰∫∫ÂëòÊï∞ÊçÆ
  const getStaffData = (orgArr = []) => {
    setMemberLoading(true);
    QueryMemberInfo({
      type: 'XXJS',
    })
      .then(res => {
        if (res?.success) {
          let memberArr = JSON.parse(res.record);
          setStaffData(p => [...memberArr]);
          setMemberLoading(false);
        }
      })
      .catch(e => {
        setMemberLoading(false);
        message.error('‰∫∫Âëò‰ø°ÊÅØÊü•ËØ¢Â§±Ë¥•', 1);
        console.error('QueryMemberInfo', e);
      });
  };

  const getTableData = (queryType = 'DRY', v, year) => {
    setMemberLoading(true);
    console.log("String(v)", String(v))
    // YJBM_ALL|ÂÖ®ÈÉ®‰∏ÄÁ∫ßÈÉ®Èó®ÔºàÈÉ®Èó®idÂíå‰∫∫ÂëòidÈÉΩ‰∏çÁî®‰º†Ôºâ;
    // YJBM_LD|Êü•ËØ¢ÂØπÂ∫î‰∏ÄÁ∫ßÈÉ®Èó®‰∏ãÁöÑÈÉ®Èó®È¢ÜÂØºÊï∞ÊçÆÔºà‰º†‰∏ÄÁ∫ßÈÉ®Èó®ÁöÑidÔºâ;
    // YJBM_BM|Êü•ËØ¢ÂØπÂ∫î‰∏ÄÁ∫ßÈÉ®Èó®‰∏ãÁöÑ‰∫åÁ∫ßÈÉ®Èó®Êï∞ÊçÆÔºà‰º†‰∏ÄÁ∫ßÈÉ®Èó®ÁöÑidÔºâ;
    // EJBM_ALL|Êü•ËØ¢ÂØπÂ∫î‰∫åÁ∫ßÈÉ®Èó®‰∏ã‰∫∫ÂëòÁöÑÊï∞ÊçÆÔºà‰º†‰∫åÁ∫ßÈÉ®Èó®ÁöÑidÔºâ;
    // RY|Êü•ËØ¢ÂØπÂ∫î‰∫∫ÂëòidÁöÑÊï∞ÊçÆÔºà‰º†‰∫∫ÂëòÁöÑidÔºâ;
    // BM|Êü•ËØ¢ÂØπÂ∫îÈÉ®Èó®ÁöÑÊï∞ÊçÆÔºàÈÉ®Èó®ÁöÑidÔºâ
    //DRY|Êü•ËØ¢ÂØπÂ∫îÂ§ö‰∏™‰∫∫ÂëòÁöÑÊï∞ÊçÆÔºõÊ†ºÂºè‰∏∫Ëã±ÊñáÊã¨Âè∑ÔºåÈáåÈù¢Â§ö‰∏™idÁî®ÈÄóÂè∑ÈöîÂºÄÔºå(11169,15508) DBMÊó∂‰º†
    //DBM|Êü•ËØ¢ÂØπÂ∫îÂ§ö‰∏™ÈÉ®Èó®ÁöÑÊï∞ÊçÆ Ê†ºÂºè‰∏∫Ëã±ÊñáÊã¨Âè∑ÔºåÊ†ºÂºè‰∏∫Ëã±ÊñáÊã¨Âè∑ÔºåÈáåÈù¢Â§ö‰∏™idÁî®ÈÄóÂè∑ÈöîÂºÄÔºå(115148,12488) DRYÊó∂‰º†
    const payload = {
      "current": 1,
      // "memberId": 0,
      "multiMember": "(" + String(v) + ")",
      "pageSize": 10,
      "paging": 1,
      "queryType": queryType,
      "sort": '',
      "total": -1,
      year: year ?? defaultYear
    }
    QueryProjectStatistics({
      ...payload
    }).then(res => {
      const {
        code = 0,
        result,
        totalrows = 0,
      } = res
      if (code > 0) {
        const resdata = JSON.parse(result);
        //ÂèëËµ∑È°πÁõÆ
        let tooltipDataXMZS = [];
        //‰∏ìÁè≠È°πÁõÆ
        let tooltipDataZBXM = [];
        //ËØæÈ¢òÈ°πÁõÆ
        let tooltipDataKTXM = [];
        //ÂèÇ‰∏éÈ°πÁõÆ
        let tooltipDataCYXM = [];
        //Ëé∑Â•ñÈ°πÁõÆ
        let tooltipDataHJXM = [];
        //Ëá™Á†îÈ°πÁõÆ
        let tooltipDataZYXM = [];
        //Â§ñÈááÈ°πÁõÆ
        let tooltipDataWCXM = [];
        //Èõ∑ËææÊï∞ÊçÆ
        let radardata = [];
        //ÂêÑÈ°πÁõÆÁ±ªÂûãÊÄªÊï∞
        //ÂèëËµ∑È°πÁõÆÊÄªÊï∞
        let totalXMZS = 0;
        //‰∏ìÁè≠È°πÁõÆÊÄªÊï∞
        let totalZBXM = 0;
        //ËØæÈ¢òÈ°πÁõÆÊÄªÊï∞
        let totalKTXM = 0;
        //ÂèÇ‰∏éÈ°πÁõÆÊÄªÊï∞
        let totalCYXM = 0;
        //Ëé∑Â•ñÈ°πÁõÆÊÄªÊï∞
        let totalHJXM = 0;
        //Ëá™Á†îÈ°πÁõÆÊÄªÊï∞
        let totalZYXM = 0;
        //Â§ñÈááÈ°πÁõÆÊÄªÊï∞
        let totalWCXM = 0;
        let name = []
        resdata.length > 0 && resdata.map(item => {
          const XMZS = {name: item.NAME, value: item.XMZS};
          const ZBXM = {name: item.NAME, value: item.ZBXM};
          const KTXM = {name: item.NAME, value: item.KTXM};
          const CYXM = {name: item.NAME, value: item.CYXM};
          const HJXM = {name: item.NAME, value: item.HJXM};
          const ZYXM = {name: item.NAME, value: item.ZYXM};
          const WCXM = {name: item.NAME, value: item.WCXM};
          // let xmzstep = item.XMZS === 0 ? 0 : (item.XMZS === 1 ? 1 : ((Math.log(item.XMZS) / Math.log(Math.E)) + 1))
          // let hjxmtep = item.HJXM === 0 ? 0 : (item.HJXM === 1 ? 1 : ((Math.log(item.HJXM) / Math.log(Math.E)) + 1))
          // let ktxmtep = item.KTXM === 0 ? 0 : (item.KTXM === 1 ? 1 : ((Math.log(item.KTXM) / Math.log(Math.E)) + 1))
          // let zbxmtep = item.ZBXM === 0 ? 0 : (item.ZBXM === 1 ? 1 : ((Math.log(item.ZBXM) / Math.log(Math.E)) + 1))
          // let xcxmtep = item.CYXM === 0 ? 0 : (item.CYXM === 1 ? 1 : ((Math.log(item.CYXM) / Math.log(Math.E)) + 1))
          // const radar = {id:item.USERID,name: item.NAME, value: [xmzstep, hjxmtep, ktxmtep, zbxmtep, xcxmtep]};
          const radar = {name: item.NAME, value: [item.HJXM, item.KTXM, item.ZBXM, item.ZYXM, item.WCXM]};
          tooltipDataXMZS.push(XMZS);
          tooltipDataZBXM.push(ZBXM);
          tooltipDataKTXM.push(KTXM);
          tooltipDataCYXM.push(CYXM);
          tooltipDataHJXM.push(HJXM);
          tooltipDataZYXM.push(ZYXM);
          tooltipDataWCXM.push(WCXM);
          radardata.push(radar)
          name.push(item.NAME);
          if (item.XMZS > totalXMZS) {
            totalXMZS = item.XMZS;
          }
          if (item.ZBXM > totalZBXM) {
            totalZBXM = item.ZBXM;
          }
          if (item.KTXM > totalKTXM) {
            totalKTXM = item.KTXM;
          }
          if (item.CYXM > totalCYXM) {
            totalCYXM = item.CYXM;
          }
          if (item.HJXM > totalHJXM) {
            totalHJXM = item.HJXM;
          }
          if (item.ZYXM > totalZYXM) {
            totalZYXM = item.ZYXM;
          }
          if (item.WCXM > totalWCXM) {
            totalWCXM = item.WCXM;
          }
        })
        let tooltipData = [{xmlx: 'Ëé∑Â•ñÈ°πÁõÆ', data: tooltipDataHJXM}, {xmlx: 'ËØæÈ¢òÈ°πÁõÆ', data: tooltipDataKTXM}, {
          xmlx: '‰∏ìÁè≠È°πÁõÆ',
          data: tooltipDataZBXM
        }, {xmlx: 'Ëá™Á†îÈ°πÁõÆ', data: tooltipDataZYXM}, {xmlx: 'Â§ñÈááÈ°πÁõÆ', data: tooltipDataWCXM}]
        let tooltipleftData = [{xmlx: 'ÂèëËµ∑È°πÁõÆ', data: tooltipDataXMZS}, {xmlx: 'ÂèÇ‰∏éÈ°πÁõÆ', data: tooltipDataCYXM}]
        setTooltipData(tooltipData);
        setTooltipleftData(tooltipleftData);
        setRadardata(radardata);
        setTotalXMZS(totalXMZS);
        setTotalZBXM(totalZBXM);
        setTotalKTXM(totalKTXM);
        setTotalCYXM(totalCYXM);
        setTotalHJXM(totalHJXM);
        setTotalZYXM(totalZYXM);
        setTotalWCXM(totalWCXM);
        setTotalArr([totalHJXM, totalKTXM, totalZBXM, totalZYXM, totalWCXM])
        console.log("namename", name)
        console.log("radardata", radardata)
        setTotalNameArr(name);
        setMemberLoading(false);
      } else {
        message.error(note)
        setMemberLoading(false);
      }
    }).catch(err => {
      message.error("Êü•ËØ¢È°πÁõÆÁªüËÆ°Â§±Ë¥•")
      setMemberLoading(false);
    })
  }

  //‰∫∫ÂëòÈÄâÊã©
  const handlePrjMngerChange = v => {
    console.log('handlePrjMngerChange', v);
    console.log('handlePrjMngerChange2222', String(v));
    // if (v === undefined) v = '';
    setPrjMnger(v);
    if (v.length > 0) {
      getTableData('DRY', v);
    } else {
      setTooltipData([]);
      setTooltipleftData([]);
      setRadardata([]);
      setTotalXMZS(0);
      setTotalZBXM(0);
      setTotalKTXM(0);
      setTotalCYXM(0);
      setTotalHJXM(0);
      setTotalZYXM(0);
      setTotalWCXM(0);
      setTotalArr([0, 0, 0, 0, 0])
      setTotalNameArr(['ÊöÇÊó†']);
    }
  };

  // console.log("tableDatatableData",tableData)

  return (
    <Modal
      wrapClassName="dataComparison-modal"
      style={{top: '10px'}}
      width={'860px'}
      title={null}
      zIndex={100}
      bodyStyle={{
        padding: '0',
      }}
      // onOk={e => this.handleFormValidate(e)}
      onCancel={closeModal}
      maskClosable={false}
      footer={null}
      visible={visible}
    >
      <div
        style={{
          height: '42px',
          width: '100%',
          display: 'flex',
          alignItems: 'center',
          backgroundColor: '#3361FF',
          color: 'white',
          // marginBottom: '16px',
          padding: '0 24px',
          borderRadius: '8px 8px 0 0',
          fontSize: '15px',
        }}
      >
        <strong>Êï∞ÊçÆÂØπÊØî</strong>
      </div>
      <Spin spinning={memberLoading} wrapperClassName="spin" tip="Ê≠£Âú®Âä™ÂäõÁöÑÂä†ËΩΩ‰∏≠..." size="large">
        <div className="info-table">
          {/*<div className="info-table-title">*/}
          {/*  È¢ÜÂØºÁªüËÆ°*/}
          {/*</div>*/}
          <div className="console-item">
            <span><span style={{
              fontFamily: 'SimSun, sans-serif',
              color: '#f5222d',
              marginRight: '4px',
              lineHeight: 1
            }}>*</span>ÈÄâÊã©‰∫∫Âëò:</span>
            <Select
              showArrow={true}
              mode="multiple"
              className="item-selector"
              dropdownClassName='item-selector-dropdown-radar'
              filterOption={(input, option) =>
                option.props.children.toLowerCase().indexOf(input.toLowerCase()) >= 0
              }
              showSearch
              allowClear
              onChange={(selectValue) => {
                console.log("selectValue", selectValue)
                // Ê®°Âºè‰∏∫Â§öÈÄâ‰∏îÂ≠òÂú®ÊúÄÂ§ßÂÄºÊó∂ÔºåÂΩìÊúÄÂ§ßÈïøÂ∫¶Â§ß‰∫éËæìÂÖ•ÈïøÂ∫¶Êó∂Ëß¶ÂèëÊ†°È™å
                if (selectValue?.length > 5) {
                  message.warn("ÊúÄÂ§öÈÄâÊã©‰∫î‰∫∫ËøõË°åÊØîËæÉÔºÅ")
                  selectValue?.pop(); // Âà†Èô§Â§ö‰ΩôÈ°π
                  handlePrjMngerChange(selectValue);
                } else {
                  handlePrjMngerChange(selectValue);
                }
              }}
              value={prjMnger}
              placeholder="ËØ∑ÈÄâÊã©"
            >
              {staffData.map((x, i) => (
                <Option key={i} value={x.id}>
                  {x.name}
                </Option>
              ))}
            </Select>
          </div>
          <div className="info-table-content">
            <div className="info-table-content-box">
              <div className="info-table-content-box-title">
                {/*<div className="info-table-content-box-title-left">*/}
                {/*  {tableData[0]?.ORGNAME}*/}
                {/*</div>*/}
                {/*<div className="info-table-content-box-title-right">*/}
                {/*  <i className="iconfont icon-vs"/>Êï∞ÊçÆÂØπÊØî*/}
                {/*</div>*/}
              </div>
              <div style={{float: 'left', margin: '10px 0',}}>
                {
                  tooltipleftData.map(item => {
                    return <div style={{
                      fontSize: '14px',
                      marginBottom: '10px',
                      color: '#303133',
                      fontWeight: 500,
                    }}>
                      <div style={{marginBottom: '6px'}}>{item.xmlx}:</div>
                      {
                        item.data.map(i => {
                          return <div style={{marginBottom: '6px'}}><span
                            style={{fontWeight: 400, color: '#999999'}}>{i.name}:</span><span
                            style={{fontWeight: 500, color: '#303133'}}>&nbsp;&nbsp;{i.value}</span><br/></div>
                        })
                      }</div>
                  })
                }
              </div>
              <div className="info-table-content-box-radar" style={{padding: '16px 0'}}>
                <ReactEchartsCore
                  echarts={echarts}
                  option={getRadarChat()}
                  notMerge
                  lazyUpdate
                  style={{height: '424px'}}
                  theme=""
                />
              </div>
            </div>
          </div>
        </div>
      </Spin>
    </Modal>
  );
}
